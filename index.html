<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keepecar6 - Controle de Veículos</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2E86C1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    h2, h3 {
      color: #2E86C1;
      text-align: center;
    }
    .container {
      background: #fff;
      padding: 20px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 400px;
    }
    input, textarea, select, button {
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #2E86C1;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #1B4F72;
    }
    canvas {
      border: 1px solid #000;
      width: 100%;
      height: 150px;
    }
    #historicoContent {
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

<h2>Keepecar6 - Controle de Veículos</h2>

<div class="container">

  <!-- Login -->
  <div id="login">
    <h3>Login</h3>
    <input type="text" id="user" placeholder="Usuário">
    <input type="password" id="pass" placeholder="Senha">
    <button onclick="login()">Entrar</button>
  </div>

  <!-- Menu Principal -->
  <div id="menu" class="hidden">
    <h3>Menu Principal</h3>
    <button onclick="show('cadastroVeiculo')">Cadastro de Veículos</button>
    <button onclick="show('registro')">Registro de Movimentação</button>
    <button onclick="showHistorico()">Histórico</button>
    <button onclick="show('assinatura')">Assinatura</button>
    <button onclick="backupJSON()">Backup JSON</button>
    <button onclick="fazerBackupPDF()">Backup PDF</button>
    <button onclick="logout()">Sair</button>
  </div>

  <!-- Cadastro Veículo -->
  <div id="cadastroVeiculo" class="hidden">
    <h3>Cadastro de Veículo</h3>
    <input type="text" id="placa" placeholder="Placa">
    <input type="text" id="modelo" placeholder="Modelo">
    <textarea id="obs" placeholder="Observações"></textarea>
    <button onclick="salvarVeiculo()">Salvar</button>
    <button onclick="voltar()">Voltar</button>
  </div>

  <!-- Registro Movimentação -->
  <div id="registro" class="hidden">
    <h3>Registro de Movimentação</h3>
    <input type="text" id="responsavel" placeholder="Responsável">
    <input type="text" id="placaMov" placeholder="Placa do Veículo">
    <select id="tipoMov">
      <option>Entrada</option>
      <option>Saída</option>
    </select>
    <button onclick="salvarRegistro()">Salvar Registro</button>
    <button onclick="voltar()">Voltar</button>
  </div>

  <!-- Histórico -->
  <div id="historico" class="hidden">
    <h3>Histórico de Registros</h3>
    <div id="historicoContent"></div>
    <button onclick="voltar()">Voltar</button>
  </div>

  <!-- Assinatura -->
  <div id="assinatura" class="hidden">
    <h3>Assinatura Digital</h3>
    <canvas id="canvas" width="300" height="150"></canvas>
    <button onclick="limparAssinatura()">Limpar</button>
    <button onclick="salvarAssinatura()">Salvar</button>
    <button onclick="voltar()">Voltar</button>
  </div>

</div>

<script>
  // Login
  function login() {
    const user = document.getElementById('user').value;
    const pass = document.getElementById('pass').value;
    if (user === 'admin' && pass === 'admin1') {
      toggle('login', false);
      toggle('menu', true);
    } else {
      alert('Usuário ou senha incorretos.');
    }
  }

  function logout() {
    location.reload();
  }

  function toggle(id, show) {
    document.getElementById(id).classList.toggle('hidden', !show);
  }

  function show(id) {
    ['menu', 'cadastroVeiculo', 'registro', 'historico', 'assinatura'].forEach(div => toggle(div, false));
    toggle(id, true);
  }

  function voltar() {
    show('menu');
  }

  // Cadastro Veículo
  function salvarVeiculo() {
    let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
    veiculos.push({
      placa: document.getElementById('placa').value,
      modelo: document.getElementById('modelo').value,
      obs: document.getElementById('obs').value
    });
    localStorage.setItem('veiculos', JSON.stringify(veiculos));
    alert('Veículo salvo.');
    voltar();
  }

  // Registro Movimentação
  function salvarRegistro() {
    let registros = JSON.parse(localStorage.getItem('registros') || '[]');
    registros.push({
      responsavel: document.getElementById('responsavel').value,
      placa: document.getElementById('placaMov').value,
      tipo: document.getElementById('tipoMov').value,
      horario: new Date().toLocaleString()
    });
    localStorage.setItem('registros', JSON.stringify(registros));
    alert('Registro salvo.');
    voltar();
  }

  // Histórico
  function showHistorico() {
    let registros = JSON.parse(localStorage.getItem('registros') || '[]');
    let content = registros.map(r => `Responsável: ${r.responsavel}\nPlaca: ${r.placa}\nTipo: ${r.tipo}\nHorário: ${r.horario}\n---`).join('\n');
    document.getElementById('historicoContent').innerText = content || 'Nenhum registro.';
    show('historico');
  }

  // Backup JSON
  function backupJSON() {
    let data = {
      veiculos: JSON.parse(localStorage.getItem('veiculos') || '[]'),
      registros: JSON.parse(localStorage.getItem('registros') || '[]')
    };
    let blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    let link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'backup_keepecar6.json';
    link.click();
  }

  // Backup PDF
  async function fazerBackupPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
    let registros = JSON.parse(localStorage.getItem('registros') || '[]');
    doc.setFontSize(16);
    doc.text("Backup - Keepecar6", 20, 20);

    doc.setFontSize(12);
    doc.text("== Veículos ==", 20, 30);
    let y = 40;
    veiculos.forEach(v => {
      doc.text(`Placa: ${v.placa} | Modelo: ${v.modelo} | Obs: ${v.obs}`, 20, y);
      y += 10;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    y += 10;
    doc.text("== Registros ==", 20, y);
    y += 10;
    registros.forEach(r => {
      doc.text(`Responsável: ${r.responsavel} | Placa: ${r.placa} | Tipo: ${r.tipo} | Horário: ${r.horario}`, 20, y);
      y += 10;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    doc.save('backup_keepecar6.pdf');
  }

  // Assinatura
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;

  canvas.addEventListener('mousedown', e => {
    drawing = true;
    ctx.moveTo(e.offsetX, e.offsetY);
  });

  canvas.addEventListener('mousemove', e => {
    if (drawing) {
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    }
  });

  canvas.addEventListener('mouseup', () => drawing = false);

  function limparAssinatura() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function salvarAssinatura() {
    const dataURL = canvas.toDataURL();
    localStorage.setItem('assinatura', dataURL);
    alert('Assinatura salva.');
  }

  // PWA Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

</body>
</html>

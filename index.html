<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keepecar6 - Controle de Veículos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .box { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    canvas { width: 100%; height: 150px; border: 1px solid #ccc; touch-action: none; }
    .hidden { display: none; }
  </style>
</head>
<body class="container py-3">

<h4 class="text-center mb-3">Keepecar6 - Controle de Veículos</h4>

<div id="login" class="box p-3 bg-white">
  <h5>Login</h5>
  <input type="text" id="user" placeholder="Usuário" class="form-control mb-2">
  <input type="password" id="pass" placeholder="Senha" class="form-control mb-2">
  <button onclick="login()" class="btn btn-primary w-100">Entrar</button>
</div>

<div id="menu" class="box p-3 bg-white hidden">
  <h5>Menu Principal</h5>
  <button onclick="show('cadastroVeiculo')" class="btn btn-outline-primary w-100 mb-2">Cadastro de Veículos</button>
  <button onclick="show('registro')" class="btn btn-outline-success w-100 mb-2">Registro de Movimentação</button>
  <button onclick="showHistorico()" class="btn btn-outline-info w-100 mb-2">Histórico</button>
  <button onclick="logout()" class="btn btn-secondary w-100">Sair</button>
</div>

<div id="cadastroVeiculo" class="box p-3 bg-white hidden">
  <h5>Cadastro de Veículos</h5>
  <input type="text" id="novoVeiculo" placeholder="Placa do Veículo" class="form-control mb-2">
  <button onclick="salvarVeiculo()" class="btn btn-success w-100">Salvar</button>
  <button onclick="voltar()" class="btn btn-secondary w-100 mt-2">Voltar</button>
</div>

<div id="registro" class="box p-3 bg-white hidden">
  <h5>Registro de Movimentação</h5>
  <input type="text" id="responsavel" placeholder="Nome do Responsável" class="form-control mb-2">
  <select id="placaSelect" class="form-select mb-2"></select>
  <select id="tipoMov" class="form-select mb-2">
    <option value="Saída">Saída</option>
    <option value="Chegada">Chegada</option>
  </select>
  <input type="datetime-local" id="dataHora" class="form-control mb-2">
  <label>Assinatura:</label>
  <canvas id="canvas"></canvas>
  <button onclick="limparAssinatura()" class="btn btn-warning w-100 mt-2">Limpar Assinatura</button>
  <button onclick="salvarRegistro()" class="btn btn-primary w-100 mt-2">Salvar Registro</button>
  <button onclick="voltar()" class="btn btn-secondary w-100 mt-2">Voltar</button>
</div>

<div id="historico" class="container box hidden p-3 bg-white">
  <h5>Histórico</h5>
  <input type="text" id="filtroTexto" placeholder="Buscar por placa, responsável ou tipo..." class="form-control mb-2" oninput="filtrarHistorico()">
  <label>Filtrar por Data:</label>
  <input type="datetime-local" id="filtroInicio" class="form-control mb-1" onchange="filtrarHistorico()">
  <input type="datetime-local" id="filtroFim" class="form-control mb-2" onchange="filtrarHistorico()">
  <div id="historicoContent" style="white-space: pre-wrap; max-height: 300px; overflow-y:auto;"></div>
  <button onclick="exportarExcel()" class="btn btn-success w-100 mb-2">Exportar para Excel</button>
  <button onclick="exportarPDF()" class="btn btn-danger w-100">Exportar para PDF</button>
  <button onclick="voltar()" class="btn btn-secondary w-100 mt-2">Voltar</button>
</div>

<script>
  function login() {
    const u = document.getElementById('user').value;
    const p = document.getElementById('pass').value;
    if (u === 'admin' && p === 'admin1') {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('menu').classList.remove('hidden');
      carregarVeiculos();
    } else {
      alert('Usuário ou senha incorretos!');
    }
  }
  function logout() { location.reload(); }
  function show(id) {
    ['menu', 'cadastroVeiculo', 'registro', 'historico'].forEach(e => document.getElementById(e).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    if (id === 'registro') carregarVeiculos();
  }
  function voltar() { show('menu'); }
  function salvarVeiculo() {
    let novo = document.getElementById('novoVeiculo').value.trim();
    if (novo) {
      let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
      veiculos.push(novo);
      localStorage.setItem('veiculos', JSON.stringify(veiculos));
      alert('Veículo cadastrado.');
      document.getElementById('novoVeiculo').value = '';
    }
  }
  function carregarVeiculos() {
    let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
    let select = document.getElementById('placaSelect');
    select.innerHTML = '<option value="">Selecione o Veículo</option>';
    veiculos.forEach(v => {
      let opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
  }
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let desenhando = false;
  canvas.addEventListener('mousedown', e => { desenhando = true; ctx.moveTo(e.offsetX, e.offsetY); });
  canvas.addEventListener('mousemove', e => { if (desenhando) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
  canvas.addEventListener('mouseup', () => { desenhando = false; });
  canvas.addEventListener('touchstart', e => { e.preventDefault(); desenhando = true; let pos = getPos(e); ctx.moveTo(pos.x, pos.y); });
  canvas.addEventListener('touchmove', e => { e.preventDefault(); if (desenhando) { let pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } });
  canvas.addEventListener('touchend', () => { desenhando = false; });
  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches) return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    else return { x: e.offsetX, y: e.offsetY };
  }
  function limparAssinatura() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
  function salvarRegistro() {
    const registro = {
      responsavel: document.getElementById('responsavel').value,
      placa: document.getElementById('placaSelect').value,
      tipo: document.getElementById('tipoMov').value,
      dataHora: document.getElementById('dataHora').value,
      assinatura: canvas.toDataURL()
    };
    if (!registro.placa) { alert('Selecione um veículo.'); return; }
    let historico = JSON.parse(localStorage.getItem('historico') || '[]');
    historico.push(registro);
    localStorage.setItem('historico', JSON.stringify(historico));
    alert('Registro salvo.');
    limparAssinatura();
    voltar();
  }
  function showHistorico() {
    renderizarHistorico(JSON.parse(localStorage.getItem('historico') || '[]'));
    show('historico');
  }
  function renderizarHistorico(lista) {
    let txt = '';
    lista.forEach((r, i) => {
      txt += `Registro ${i + 1}:
Responsável: ${r.responsavel}
Placa: ${r.placa}
Tipo: ${r.tipo}
Data/Hora: ${r.dataHora}
---\n`;
    });
    document.getElementById('historicoContent').innerText = txt || 'Nenhum registro.';
  }
  function filtrarHistorico() {
    let texto = document.getElementById('filtroTexto').value.toLowerCase();
    let inicio = document.getElementById('filtroInicio').value;
    let fim = document.getElementById('filtroFim').value;
    let historico = JSON.parse(localStorage.getItem('historico') || '[]');
    let filtrado = historico.filter(r => {
      let matchTexto = !texto || r.responsavel.toLowerCase().includes(texto) || r.placa.toLowerCase().includes(texto) || r.tipo.toLowerCase().includes(texto);
      let matchData = true;
      if (inicio && r.dataHora < inicio) matchData = false;
      if (fim && r.dataHora > fim) matchData = false;
      return matchTexto && matchData;
    });
    renderizarHistorico(filtrado);
  }
  function exportarExcel() {
    let historico = JSON.parse(localStorage.getItem('historico') || '[]');
    if (historico.length === 0) { alert('Nenhum registro para exportar.'); return; }
    let ws_data = [["Responsável", "Placa", "Tipo", "Data/Hora"]];
    historico.forEach(r => {
      ws_data.push([r.responsavel, r.placa, r.tipo, r.dataHora]);
    });
    let wb = XLSX.utils.book_new();
    let ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Histórico");
    XLSX.writeFile(wb, "historico.xlsx");
  }
  async function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    const element = document.getElementById('historicoContent');
    await html2canvas(element).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save('historico.pdf');
    });
  }
</script>

</body>
</html>

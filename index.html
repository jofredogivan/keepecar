<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keepecar6 - Controle de Veículos</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2E86C1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 10px;
    }
    .box {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #2E86C1;
      color: white;
      border: none;
      cursor: pointer;
    }
    canvas {
      border: 1px solid #ccc;
      width: 100%;
      height: 150px;
      touch-action: none;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

<div id="login" class="box">
  <h3>Login</h3>
  <input type="text" id="user" placeholder="Usuário">
  <input type="password" id="pass" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<div id="menu" class="box hidden">
  <h3>Menu Principal</h3>
  <button onclick="show('registro')">Registro de Movimentação</button>
  <button onclick="showHistorico()">Histórico</button>
  <button onclick="backupJSON()">Backup JSON</button>
  <button onclick="fazerBackupPDF()">Backup PDF</button>
  <button onclick="logout()">Sair</button>
</div>

<div id="registro" class="box hidden">
  <h3>Registro de Movimentação</h3>
  <input type="text" id="responsavel" placeholder="Nome do Responsável">
  <input type="text" id="placa" placeholder="Placa do Veículo">
  <input type="datetime-local" id="saida">
  <input type="datetime-local" id="chegada">

  <h4>Assinatura:</h4>
  <canvas id="canvas"></canvas>
  <button onclick="limparAssinatura()">Limpar Assinatura</button>
  <button onclick="salvarRegistro()">Salvar Registro</button>
  <button onclick="voltar()">Voltar</button>
</div>

<div id="historico" class="box hidden">
  <h3>Histórico</h3>
  <div id="historicoContent" style="white-space: pre-wrap; max-height: 300px; overflow-y:auto;"></div>
  <button onclick="voltar()">Voltar</button>
</div>

<script>
  // Login
  function login() {
    const u = document.getElementById('user').value;
    const p = document.getElementById('pass').value;
    if (u === 'admin' && p === 'admin1') {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('menu').classList.remove('hidden');
    } else {
      alert('Usuário ou senha incorretos!');
    }
  }

  function logout() { location.reload(); }

  function show(id) {
    ['menu', 'registro', 'historico'].forEach(e => document.getElementById(e).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  function voltar() { show('menu'); }

  // Canvas assinatura (compatível com touch)
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let desenhando = false;

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches) {
      return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    } else {
      return { x: e.offsetX, y: e.offsetY };
    }
  }

  canvas.addEventListener('mousedown', e => { desenhando = true; ctx.moveTo(e.offsetX, e.offsetY); });
  canvas.addEventListener('mousemove', e => { if (desenhando) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
  canvas.addEventListener('mouseup', () => { desenhando = false; });

  canvas.addEventListener('touchstart', e => { e.preventDefault(); desenhando = true; const pos = getPos(e); ctx.moveTo(pos.x, pos.y); });
  canvas.addEventListener('touchmove', e => { e.preventDefault(); if (desenhando) { const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } });
  canvas.addEventListener('touchend', () => { desenhando = false; });

  function limparAssinatura() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function salvarRegistro() {
    const registro = {
      responsavel: document.getElementById('responsavel').value,
      placa: document.getElementById('placa').value,
      saida: document.getElementById('saida').value,
      chegada: document.getElementById('chegada').value,
      assinatura: canvas.toDataURL()
    };
    let historico = JSON.parse(localStorage.getItem('historico') || '[]');
    historico.push(registro);
    localStorage.setItem('historico', JSON.stringify(historico));
    alert('Registro salvo.');
    limparAssinatura();
    voltar();
  }

  function showHistorico() {
    let h = JSON.parse(localStorage.getItem('historico') || '[]');
    let txt = '';
    h.forEach((r, i) => {
      txt += `Registro ${i + 1}:\nResponsável: ${r.responsavel}\nPlaca: ${r.placa}\nSaída: ${r.saida}\nChegada: ${r.chegada}\n---\n`;
    });
    document.getElementById('historicoContent').innerText = txt || 'Nenhum registro.';
    show('historico');
  }

  function backupJSON() {
    let data = localStorage.getItem('historico');
    let blob = new Blob([data], { type: 'application/json' });
    let link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'backup_keepecar6.json';
    link.click();
  }

  async function fazerBackupPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let h = JSON.parse(localStorage.getItem('historico') || '[]');
    let y = 20;
    doc.setFontSize(16);
    doc.text('Backup de Movimentação', 20, y);
    y += 10;
    h.forEach((r, i) => {
      doc.setFontSize(10);
      doc.text(`Registro ${i + 1}:`, 20, y);
      y += 5;
      doc.text(`Responsável: ${r.responsavel}`, 20, y); y += 5;
      doc.text(`Placa: ${r.placa}`, 20, y); y += 5;
      doc.text(`Saída: ${r.saida}`, 20, y); y += 5;
      doc.text(`Chegada: ${r.chegada}`, 20, y); y += 10;
      if (y > 270) { doc.addPage(); y = 20; }
    });
    doc.save('backup_keepecar6.pdf');
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

</body>
</html>


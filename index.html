<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keepecar6 - Controle de Veículos</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2E86C1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f0f0f0; }
    #menu, #cadastroVeiculo, #registro, #historico, #assinatura { display: none; }
    button { margin: 5px; padding: 10px; }
    input, textarea { margin: 5px; padding: 5px; }
  </style>
</head>
<body>

<h2>Keepecar6 - Controle de Veículos</h2>

<!-- Login -->
<div id="login">
  <h3>Login</h3>
  <input type="text" id="user" placeholder="Usuário"><br>
  <input type="password" id="pass" placeholder="Senha"><br>
  <button onclick="login()">Entrar</button>
</div>

<!-- Menu -->
<div id="menu">
  <h3>Menu Principal</h3>
  <button onclick="show('cadastroVeiculo')">Cadastro de Veículos</button>
  <button onclick="show('registro')">Registro de Movimentação</button>
  <button onclick="showHistorico()">Histórico</button>
  <button onclick="show('assinatura')">Assinatura</button>
  <button onclick="backupJSON()">Backup JSON</button>
  <button onclick="fazerBackupPDF()">Backup PDF</button>
  <button onclick="logout()">Sair</button>
</div>

<!-- Cadastro de Veículos -->
<div id="cadastroVeiculo">
  <h3>Cadastro de Veículo</h3>
  <input type="text" id="placa" placeholder="Placa"><br>
  <input type="text" id="modelo" placeholder="Modelo"><br>
  <textarea id="obs" placeholder="Observações"></textarea><br>
  <button onclick="salvarVeiculo()">Salvar</button>
  <button onclick="voltar()">Voltar</button>
</div>

<!-- Registro de Movimentação -->
<div id="registro">
  <h3>Registro de Movimentação</h3>
  <input type="text" id="responsavel" placeholder="Responsável"><br>
  <input type="text" id="placaMov" placeholder="Placa do Veículo"><br>
  <select id="tipoMov">
    <option>Entrada</option>
    <option>Saída</option>
  </select><br>
  <button onclick="salvarRegistro()">Salvar Registro</button>
  <button onclick="voltar()">Voltar</button>
</div>

<!-- Histórico -->
<div id="historico">
  <h3>Histórico de Registros</h3>
  <pre id="historicoContent"></pre>
  <button onclick="voltar()">Voltar</button>
</div>

<!-- Assinatura -->
<div id="assinatura">
  <h3>Assinatura Digital</h3>
  <canvas id="canvas" width="300" height="150" style="border:1px solid #000;"></canvas><br>
  <button onclick="limparAssinatura()">Limpar</button>
  <button onclick="salvarAssinatura()">Salvar</button>
  <button onclick="voltar()">Voltar</button>
</div>

<script>
  // Login simples
  function login() {
    const user = document.getElementById('user').value;
    const pass = document.getElementById('pass').value;
    if (user === 'admin' && pass === 'admin1') {
      document.getElementById('login').style.display = 'none';
      document.getElementById('menu').style.display = 'block';
    } else {
      alert('Usuário ou senha incorretos.');
    }
  }

  function logout() {
    location.reload();
  }

  function show(id) {
    document.querySelectorAll('#menu, #cadastroVeiculo, #registro, #historico, #assinatura').forEach(div => div.style.display = 'none');
    document.getElementById(id).style.display = 'block';
  }

  function voltar() {
    show('menu');
  }

  // Cadastro de Veículo
  function salvarVeiculo() {
    let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
    veiculos.push({
      placa: document.getElementById('placa').value,
      modelo: document.getElementById('modelo').value,
      obs: document.getElementById('obs').value
    });
    localStorage.setItem('veiculos', JSON.stringify(veiculos));
    alert('Veículo salvo.');
    voltar();
  }

  // Registro de movimentação
  function salvarRegistro() {
    let registros = JSON.parse(localStorage.getItem('registros') || '[]');
    registros.push({
      responsavel: document.getElementById('responsavel').value,
      placa: document.getElementById('placaMov').value,
      tipo: document.getElementById('tipoMov').value,
      horario: new Date().toLocaleString()
    });
    localStorage.setItem('registros', JSON.stringify(registros));
    alert('Registro salvo.');
    voltar();
  }

  // Histórico
  function showHistorico() {
    let registros = JSON.parse(localStorage.getItem('registros') || '[]');
    document.getElementById('historicoContent').textContent = JSON.stringify(registros, null, 2);
    show('historico');
  }

  // Backup JSON
  function backupJSON() {
    let data = {
      veiculos: JSON.parse(localStorage.getItem('veiculos') || '[]'),
      registros: JSON.parse(localStorage.getItem('registros') || '[]')
    };
    let blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    let link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'backup_keepecar6.json';
    link.click();
  }

  // Backup PDF
  async function fazerBackupPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
    let registros = JSON.parse(localStorage.getItem('registros') || '[]');

    doc.setFontSize(16);
    doc.text("Backup - Keepecar6", 20, 20);

    doc.setFontSize(12);
    doc.text("== Veículos Cadastrados ==", 20, 30);
    let y = 40;
    veiculos.forEach(v => {
      doc.text(`Placa: ${v.placa} | Modelo: ${v.modelo} | Obs: ${v.obs}`, 20, y);
      y += 10;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    y += 10;
    doc.text("== Registros de Movimentação ==", 20, y);
    y += 10;

    registros.forEach(r => {
      doc.text(`Responsável: ${r.responsavel} | Placa: ${r.placa} | Tipo: ${r.tipo} | Horário: ${r.horario}`, 20, y);
      y += 10;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    doc.save('backup_keepecar6.pdf');
  }

  // Assinatura Digital
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;

  canvas.addEventListener('mousedown', e => {
    drawing = true;
    ctx.moveTo(e.offsetX, e.offsetY);
  });

  canvas.addEventListener('mousemove', e => {
    if (drawing) {
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    }
  });

  canvas.addEventListener('mouseup', () => drawing = false);

  function limparAssinatura() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function salvarAssinatura() {
    const dataURL = canvas.toDataURL();
    localStorage.setItem('assinatura', dataURL);
    alert('Assinatura salva no navegador.');
  }

  // Instalação PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

</body>
</html>

